<% content_for :page_header do %>
  <div class="md:flex md:items-center md:justify-between">
    <div class="min-w-0 flex-1">
      <div class="mb-2">
        <%= link_to stats_path(start_date: @start_date, end_date: @end_date),
            class: "inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700" do %>
          <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          <%= t("stats.back_to_global") %>
        <% end %>
      </div>
      <h1 class="text-2xl/7 font-bold text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight"><%= @residence.name %></h1>
      <p class="mt-1 text-sm text-gray-500"><%= @residence.address %></p>
    </div>
    <div class="mt-4 flex md:mt-0 md:ml-4">
      <%= link_to stat_path(@residence, format: :csv, start_date: @start_date, end_date: @end_date),
          download: "statistiques-#{@residence.name.parameterize}.csv",
          data: { turbo: false },
          class: "inline-flex items-center gap-2 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-xs ring-1 ring-inset ring-gray-300 hover:bg-gray-50" do %>
        <svg class="size-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <%= t("stats.export_csv") %>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Date Filter -->
<%= render "date_filter" %>

<!-- Stats Cards - Design Components Style -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-8">
  <div class="grid grid-cols-1 gap-px bg-gray-200/50 sm:grid-cols-2 lg:grid-cols-4">
    <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
      <p class="text-sm/6 font-medium text-gray-500"><%= t("stats.metrics.total_activities") %></p>
      <p class="mt-2 flex items-baseline gap-x-2">
        <span class="text-4xl font-semibold tracking-tight text-gray-900"><%= @total_activities %></span>
      </p>
    </div>
    <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
      <p class="text-sm/6 font-medium text-gray-500"><%= t("stats.metrics.total_participants") %></p>
      <p class="mt-2 flex items-baseline gap-x-2">
        <span class="text-4xl font-semibold tracking-tight text-gray-900"><%= @total_participants %></span>
      </p>
    </div>
    <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
      <p class="text-sm/6 font-medium text-gray-500"><%= t("stats.metrics.average_participants") %></p>
      <p class="mt-2 flex items-baseline gap-x-2">
        <span class="text-4xl font-semibold tracking-tight text-gray-900"><%= @average_participants %></span>
      </p>
    </div>
    <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
      <p class="text-sm/6 font-medium text-gray-500"><%= t("stats.metrics.median_participants") %></p>
      <p class="mt-2 flex items-baseline gap-x-2">
        <span class="text-4xl font-semibold tracking-tight text-gray-900"><%= @median_participants %></span>
      </p>
    </div>
  </div>
</div>

<!-- Charts -->
<% if @total_activities.positive? %>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8" data-controller="stats-charts"
       data-stats-charts-by-type-value="<%= @by_type.to_h.to_json %>"
       data-stats-charts-participants-by-type-value="<%= @participants_by_type.to_h.to_json %>"
       data-stats-charts-by-day-value="<%= @by_day_of_week.to_json %>"
       data-stats-charts-participants-by-day-value="<%= @participants_by_day.to_json %>"
       data-stats-charts-by-time-value="<%= @by_time_of_day.to_json %>"
       data-stats-charts-participants-by-time-value="<%= @participants_by_time.to_json %>">

    <!-- By Activity Type - Activities -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_type") %> - <%= t("stats.legend.activities") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="activitiesByTypeChart"></canvas>
      </div>
    </div>

    <!-- By Day of Week - Activities -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_day") %> - <%= t("stats.legend.activities") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="activitiesByDayChart"></canvas>
      </div>
    </div>

    <!-- By Time of Day - Activities -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_time") %> - <%= t("stats.legend.activities") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="activitiesByTimeChart"></canvas>
      </div>
    </div>

    <!-- By Activity Type - Participants -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_type") %> - <%= t("stats.legend.participants") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="participantsByTypeChart"></canvas>
      </div>
    </div>

    <!-- By Day of Week - Participants -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_day") %> - <%= t("stats.legend.participants") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="participantsByDayChart"></canvas>
      </div>
    </div>

    <!-- By Time of Day - Participants -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_time") %> - <%= t("stats.legend.participants") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="participantsByTimeChart"></canvas>
      </div>
    </div>
  </div>
<% else %>
  <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100 text-center mb-8">
    <p class="text-gray-500"><%= t("stats.no_data") %></p>
  </div>
<% end %>
