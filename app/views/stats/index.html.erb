<% content_for :page_header do %>
  <div class="md:flex md:items-center md:justify-between">
    <div class="min-w-0 flex-1">
      <h1 class="text-2xl/7 font-bold text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight"><%= t("stats.index.title") %></h1>
    </div>
    <div class="mt-4 flex md:mt-0 md:ml-4">
      <%= link_to stats_path(format: :csv, start_date: @start_date, end_date: @end_date),
          class: "inline-flex items-center gap-2 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-xs ring-1 ring-inset ring-gray-300 hover:bg-gray-50" do %>
        <svg class="size-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <%= t("stats.export_csv") %>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Date Filter -->
<%= render "date_filter" %>

<!-- Stats Cards - Design Components Style -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-8">
  <div class="grid grid-cols-1 gap-px bg-gray-200/50 sm:grid-cols-2 lg:grid-cols-6">
    <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
      <p class="text-sm/6 font-medium text-gray-500"><%= t("stats.metrics.active_residences") %></p>
      <p class="mt-2 flex items-baseline gap-x-2">
        <span class="text-4xl font-semibold tracking-tight text-gray-900"><%= @active_residences %></span>
      </p>
    </div>
    <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
      <p class="text-sm/6 font-medium text-gray-500"><%= t("stats.metrics.total_activities") %></p>
      <p class="mt-2 flex items-baseline gap-x-2">
        <span class="text-4xl font-semibold tracking-tight text-gray-900"><%= @total_activities %></span>
      </p>
    </div>
    <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
      <p class="text-sm/6 font-medium text-gray-500"><%= t("stats.metrics.total_participants") %></p>
      <p class="mt-2 flex items-baseline gap-x-2">
        <span class="text-4xl font-semibold tracking-tight text-gray-900"><%= @total_participants %></span>
      </p>
    </div>
    <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
      <p class="text-sm/6 font-medium text-gray-500"><%= t("stats.metrics.average_participants") %></p>
      <p class="mt-2 flex items-baseline gap-x-2">
        <span class="text-4xl font-semibold tracking-tight text-gray-900"><%= @average_participants %></span>
      </p>
    </div>
    <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
      <p class="text-sm/6 font-medium text-gray-500"><%= t("stats.metrics.median_participants") %></p>
      <p class="mt-2 flex items-baseline gap-x-2">
        <span class="text-4xl font-semibold tracking-tight text-gray-900"><%= @median_participants %></span>
      </p>
    </div>
    <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
      <p class="text-sm/6 font-medium text-gray-500"><%= t("stats.metrics.most_popular_type") %></p>
      <p class="mt-2">
        <span class="text-lg font-semibold tracking-tight text-gray-900"><%= @most_popular_type || "-" %></span>
      </p>
    </div>
  </div>
</div>

<!-- Charts -->
<% if @total_activities.positive? %>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8" data-controller="stats-charts"
       data-stats-charts-by-type-value="<%= @by_type.to_h.to_json %>"
       data-stats-charts-participants-by-type-value="<%= @participants_by_type.to_h.to_json %>"
       data-stats-charts-by-day-value="<%= @by_day_of_week.to_json %>"
       data-stats-charts-participants-by-day-value="<%= @participants_by_day.to_json %>"
       data-stats-charts-by-time-value="<%= @by_time_of_day.to_json %>"
       data-stats-charts-participants-by-time-value="<%= @participants_by_time.to_json %>">

    <!-- By Activity Type - Activities -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_type") %> - <%= t("stats.legend.activities") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="activitiesByTypeChart"></canvas>
      </div>
    </div>

    <!-- By Day of Week - Activities -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_day") %> - <%= t("stats.legend.activities") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="activitiesByDayChart"></canvas>
      </div>
    </div>

    <!-- By Time of Day - Activities -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_time") %> - <%= t("stats.legend.activities") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="activitiesByTimeChart"></canvas>
      </div>
    </div>

    <!-- By Activity Type - Participants -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_type") %> - <%= t("stats.legend.participants") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="participantsByTypeChart"></canvas>
      </div>
    </div>

    <!-- By Day of Week - Participants -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_day") %> - <%= t("stats.legend.participants") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="participantsByDayChart"></canvas>
      </div>
    </div>

    <!-- By Time of Day - Participants -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
      <h3 class="text-sm font-medium text-gray-900 mb-3"><%= t("stats.breakdowns.by_time") %> - <%= t("stats.legend.participants") %></h3>
      <div class="h-40">
        <canvas data-stats-charts-target="participantsByTimeChart"></canvas>
      </div>
    </div>
  </div>
<% else %>
  <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100 text-center mb-8">
    <p class="text-gray-500"><%= t("stats.no_data") %></p>
  </div>
<% end %>

<!-- Residences List -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100">
  <div class="px-6 py-4 border-b border-gray-100">
    <h2 class="text-lg font-semibold text-gray-900"><%= t("stats.residences_list") %></h2>
  </div>
  <div class="divide-y divide-gray-100">
    <% @residences.each do |residence| %>
      <% residence_activities = @activities.where(residence: residence) %>
      <% residence_participants = residence_activities.sum(:participants_count) %>
      <%= link_to stat_path(residence, start_date: @start_date, end_date: @end_date),
                  class: "flex items-center justify-between px-6 py-4 hover:bg-gray-50 transition-colors" do %>
        <div class="min-w-0 flex-1">
          <p class="font-medium text-gray-900"><%= residence.name %></p>
          <p class="text-sm text-gray-500 truncate"><%= residence.address %></p>
        </div>
        <div class="flex items-center gap-6">
          <div class="text-right">
            <p class="text-sm font-medium text-gray-900"><%= residence_activities.count %></p>
            <p class="text-xs text-gray-500"><%= t("stats.activities_count") %></p>
          </div>
          <div class="text-right">
            <p class="text-sm font-medium text-gray-900"><%= residence_participants %></p>
            <p class="text-xs text-gray-500"><%= t("stats.participants_count") %></p>
          </div>
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
